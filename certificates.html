<!DOCTYPE html>
<html>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">

<div class="container" style="margin-top:20px">

	<h1 style="margin-bottom:20px;">Certificates Application</h1>


	<!-- --------------- START CARD: get certificates --------------- -->
	<div class="card my-5" >
		<h5 class="card-header">Get Certificates</h5>

		<div class="mx-3 my-3">

			<div class="form-group row">
			    <div class="col-2">
			    	Get Certificates
			    </div>
			    <div class="col-sm-10">
			      <button type="submit" class="btn btn-primary" onclick="getCertificates()">Get Certificates</button>
			    </div>
			</div>


			<div class="form-group row">
			    <div class="col-2"></div>
			    <div class="col-sm-10">
			      <div id="certificateList"></div>
			    </div>
			</div>


		</div>

	</div>
	<!-- --------------- END CARD: get certificates --------------- -->




	<!-- --------------- START CARD: add certificate --------------- -->
	<div class="card" >
		<h5 class="card-header">Add Certificate</h5>

		<div class="mx-3 my-3">
			<div class="form-group row">
			    <label class="col-sm-2 col-form-label">First Name</label>
			    <div class="col-sm-10">
			      <input type="text" class="form-control" placeholder="enter first name" id="firstName">
			    </div>
			</div>

			<div class="form-group row">
			    <label class="col-sm-2 col-form-label">Last Name</label>
			    <div class="col-sm-10">
			      <input type="text" class="form-control" placeholder="enter last name" id="lastName">
			    </div>
			</div>

			<div class="form-group row">
			    <label class="col-sm-2 col-form-label">Course Name</label>
			    <div class="col-sm-10">
			      <input type="text" class="form-control" placeholder="enter course name" id="courseName">
			    </div>
			</div>

			<div class="form-group row">
			    <label class="col-sm-2 col-form-label">Course Number</label>
			    <div class="col-sm-10">
			      <input type="text" class="form-control" placeholder="enter course number" id="courseNumber">
			    </div>
			</div>

			<div class="form-group row">
			    <label class="col-sm-2 col-form-label">Grade</label>
			    <div class="col-sm-10">
			      <input type="text" class="form-control" placeholder="enter grade" id="grade">
			    </div>
			</div>

			<div class="form-group row">
			    <label class="col-sm-2 col-form-label">Hash</label>
			    <div class="col-sm-10">
			      <input type="text" class="form-control form-control-sm" placeholder="" id="hash">
			    </div>
			</div>

			<div class="form-group row">
			    <div class="col-2"></div>
			    <div class="col-sm-10">
			      <button type="submit" class="btn btn-primary" onclick="addCertificate()">Add Certificate</button>
			    </div>
			</div>

			<div class="form-group row">
			    <div class="col-2"></div>
			    <div class="col-sm-10">
			      <div id="addCertStatus"></div>
			    </div>
			</div>			
		</div>

	</div>
	<!-- --------------- END CARD: add certificate --------------- -->


	<!-- --------------- START CARD: certificate count --------------- -->
	<div class="card my-5" >
		<h5 class="card-header">Certificate Count</h5>

		<div class="mx-3 my-3">

			<div class="form-group row">
			    <div class="col-2">
			    	Certficate Count
			    </div>
			    <div class="col-sm-10">
			      <button type="submit" class="btn btn-primary" onclick="getCertificatesLength()">Certificate Count</button>
			    </div>
			</div>


			<div class="form-group row">
			    <div class="col-2"></div>
			    <div class="col-sm-10">
			      <div id="certificateCountStatus"></div>
			    </div>
			</div>


		</div>

	</div>
	<!-- --------------- END CARD: certificate count --------------- -->


	<!-- --------------- START CARD: get certificate --------------- -->
	<div class="card my-5" >
		<h5 class="card-header">Get Certificate</h5>

		<div class="mx-3 my-3">

			<div class="form-group row">
			    <label class="col-sm-2 col-form-label">Certificate Index Position</label>
			    <div class="col-sm-10">
			      <input type="number" class="form-control form-control-lg" placeholder="enter certificate index position" id="index">
			    </div>
			</div>

			<div class="form-group row">
			    <div class="col-2">
			    	Get Certificate
			    </div>
			    <div class="col-sm-10">
			      <button type="submit" class="btn btn-primary" onclick="getCertificate()">Get Certificate</button>
			    </div>
			</div>


			<div class="form-group row">
			    <div class="col-2"></div>
			    <div class="col-sm-10">
			      <div id="certificateData"></div>
			    </div>
			</div>

		</div>

	</div>
	<!-- --------------- END CARD: get certificate --------------- -->



	<!-- ----------- modal window for users without metamast ----------- -->
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered" role="document">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="exampleModalLongTitle">Warning!</h5>
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body">
	        You need to instal the MetaMask browser plugin and create an account before you can use this application.
	      </div>
	      <div class="modal-footer">
	      </div>
	    </div>
	  </div>
	</div>



</div>


<!-- ----------- bootstrap libraries ----------- -->
<script src="sha256.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>



<!-- ----------- application logic ----------- -->
<script>

// get a handle of form input fields
// --------------------------------------------------------
var firstName    = document.getElementById('firstName');
var lastName     = document.getElementById('lastName');
var courseName   = document.getElementById('courseName');
var courseNumber = document.getElementById('courseNumber');
var grade        = document.getElementById('grade');
var hash         = document.getElementById('hash');
var index 		 = document.getElementById('index');
var addCertStatus= document.getElementById('addCertStatus');
var certificateList = document.getElementById('certificateList');
var certificateData = document.getElementById('certificateData');
var certificateCountStatus = document.getElementById('certificateCountStatus');


// create an instance of web3 from MetaMask
// --------------------------------------------------------
if (typeof web3 !== 'undefined') {
  web3 = new Web3(web3.currentProvider);
} else {
  // set the provider you want from Web3.providers
  console.log('in modal option');
  $('#myModal').modal('show');
  //web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
  //
}

// instructors contract 
// --------------------------------------------------------
var abi = [{"constant": false, "inputs": [{"name": "_firstName", "type": "string"}, {"name": "_lastName", "type": "string"}, {"name": "_courseName", "type": "string"}, {"name": "_courseNumber", "type": "string"}, {"name": "_grade", "type": "string"}, {"name": "_certHash", "type": "bytes32"} ], "name": "addCertificate", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function"}, {"constant": true, "inputs": [{"name": "index", "type": "uint256"} ], "name": "getCertificate", "outputs": [{"name": "", "type": "string"}, {"name": "", "type": "string"}, {"name": "", "type": "string"}, {"name": "", "type": "string"}, {"name": "", "type": "string"}, {"name": "", "type": "bytes32"} ], "payable": false, "stateMutability": "view", "type": "function"}, {"constant": true, "inputs": [], "name": "getCertificatesLength", "outputs": [{"name": "", "type": "uint256"} ], "payable": false, "stateMutability": "view", "type": "function"} ];
// create contract instance
var MyContract = web3.eth.contract(abi);
var myContractInstance = MyContract.at('0xCA5869543Ac31Ccb25A8b8a7E5964EA58B53489D');


function getCertificatesLength(){

	myContractInstance.getCertificatesLength(function(err,res){
		if(err){
			console.log('Error: see console');
			console.log(err);
			return;
		}
		console.log(res);
		certificateCountStatus.innerHTML = res;
	});

}

function getCertificate(){
	var _index = index.value;
	certificateData.innerHTML = '';

	myContractInstance.getCertificate(_index,function(err,res){
		if(err){
			console.log('Error: see console');
			console.log(err);
			return;
		}
		console.log(res);
		var card = certificateCard(res);
		certificateData.innerHTML += card;
	});

}

function getCertificates(){

	myContractInstance.getCertificatesLength(function(err,res){
		if(err){
			console.log('Error: see console');
			console.log(err);
			return;
		}
		console.log(res);

		certificateList.innerHTML = '';
		var length = res.c[0];

		for (var i=0; i<length; i++){
			myContractInstance.getCertificate(i,function(err,res){
				if(err){
					console.log('Error: see console');
					console.log(err);
					return;
				}
				console.log(res);
				var card = certificateCard(res);
				certificateList.innerHTML += card;
			});
		}

	});
}

function certificateCard(cert){
	var html = '';
	html += '<div class="card text-white bg-primary mb-3">';
	html += '  <div class="card-body">';
	html += '    <small>Name: ' + cert[0] + ' ' + cert[1] + '</small><br>';
	html += '    <small>Course: ' + cert[3] + ', ' + cert[2] + '</small><br>';
	html += '    <small>Grade: ' + cert[4] + '</small><br>';
	html += '    <small>Hash: ' + cert[5] + '</small><br>';
	html += '  </div>';
	html += '</div>';
	return html;
}

function addCertificate(){

	// "0x341f85f5eca6304166fcfb6f591d49f6019f23fa39be0615e6417da06bf747ce"
	// "0x2230783334316638356635656361363330343136366663666236663539316434"
	var _firstName    = firstName.value;
	var _lastName     = lastName.value;
	var _courseName   = courseName.value;
	var _courseNumber = courseNumber.value;
	var _grade        = grade.value;
	var _hash         = hash.value;
	_hash = '0x' + _hash;

	myContractInstance.addCertificate(_firstName, _lastName, _courseName, _courseNumber, _grade, _hash, function(err,res){
		if(err){
			addCertStatus.innerHTML = '<p class="text-danger">Error: see console</p>';
			setTimeout(function(){ addCertStatus.innerHTML = ''; },3000);			
			console.log(err);
			return;
		}
		console.log(res);

		// clear fields after post
		firstName.value    = '';
		lastName.value     = '';
		courseName.value   = '';
		courseNumber.value = '';
		grade.value        = '';
		hash.value         = hash.value = CryptoJS.SHA256('');
		addCertStatus.innerHTML = '<p class="text-success">Transaction Started!</p>';
		setTimeout(function(){ addCertStatus.innerHTML = ''; },3000);

	});

}


// handle input event
function hashData(){
	var data = $('#firstName').val() + $('#lastName').val() + $('#courseName').val() + $('#courseNumber').val() + $('#grade').val();
	$('#hash').val(CryptoJS.SHA256(data));
}


window.onload = function(){	
	// set empty hash
	hash.value = CryptoJS.SHA256('');

	// set input event handler function
    firstName.oninput    = hashData;
    lastName.oninput     = hashData;
    courseName.oninput   = hashData;
    courseNumber.oninput = hashData;
    grade.oninput        = hashData;
};

</script>



</html>

